# Elasticsearch 数据导入工具

这是一个专门用于将 `222.json` 文件中的性能监控数据导入到本地 Elasticsearch 的 Python 工具集。

## 🚀 快速开始

### 方法一：一键运行（推荐）
```bash
# Windows用户
双击运行 "快速导入.bat"

# 或者命令行运行
python quick_import.py
```

### 方法二：手动运行
```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 运行导入脚本
python import_to_es.py

# 3. 测试导入结果
python test_import.py
```

## 📁 文件说明

| 文件名 | 功能描述 |
|--------|----------|
| `import_to_es.py` | 主要的导入脚本，包含完整的数据处理和导入功能 |
| `quick_import.py` | 快速导入脚本，自动检查环境并运行导入 |
| `test_import.py` | 测试脚本，验证导入的数据质量和搜索功能 |
| `快速导入.bat` | Windows批处理文件，双击即可运行 |
| `requirements.txt` | Python依赖包列表 |
| `ES导入脚本使用说明.md` | 详细的使用说明文档 |

## 🔧 功能特性

### 数据处理功能
- ✅ **正则表达式验证**：IP地址、主机名、时间戳等字段格式验证
- ✅ **数据清洗**：移除危险字符和控制字符
- ✅ **类型转换**：自动识别和转换数值、日期等类型
- ✅ **错误处理**：跳过无效数据并记录错误

### 导入功能
- ✅ **批量导入**：支持大文件分批处理
- ✅ **自动索引创建**：根据数据结构自动创建ES索引
- ✅ **重试机制**：网络异常时自动重试
- ✅ **进度监控**：实时显示导入进度

### 正则表达式处理
- **IP地址验证**：`^(\d{1,3}\.){3}\d{1,3}$`
- **主机名清理**：`[^\w\-\.]` → 替换为 `_`
- **时间戳验证**：`^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}`
- **数值验证**：`^-?\d+(\.\d+)?$`
- **文本清理**：移除 `[<>"\']` 和控制字符 `[\x00-\x1f\x7f-\x9f]`

## 📊 数据结构

导入的数据包含以下主要字段：
- `hostip`: 主机IP地址 (IP类型)
- `hostname`: 主机名 (关键字类型)
- `process_val`, `value`: 性能数值 (双精度浮点数)
- `@timestamp`: 时间戳 (日期类型)
- `agent`: 监控代理 (文本类型)
- `mngtorg`: 管理机构 (文本类型)
- `vendor`: 厂商信息 (关键字类型)
- `kpi`: 关键性能指标 (关键字数组)

## 🛠️ 环境要求

- Python 3.6+
- Elasticsearch 7.x 或 8.x
- 本地ES服务运行在 `localhost:9200`

## 📝 使用示例

### 基本导入
```bash
python import_to_es.py --file 222.json
```

### 自定义ES地址
```bash
python import_to_es.py --host 192.168.1.100 --port 9200
```

### 带认证的导入
```bash
python import_to_es.py --user elastic --password your_password
```

### 调整批量大小
```bash
python import_to_es.py --batch-size 500
```

## 🧪 测试验证

运行测试脚本验证导入结果：
```bash
python test_import.py
```

测试内容包括：
- ES连接测试
- 索引信息查看
- 数据质量检查
- 搜索功能测试
- 正则表达式验证

## 📋 日志记录

- 日志文件：`es_import.log`
- 包含详细的导入过程和错误信息
- 支持控制台和文件双重输出

## ⚠️ 注意事项

1. 确保 Elasticsearch 服务正在运行
2. 确保 `222.json` 文件在当前目录
3. 大文件导入可能需要较长时间，请耐心等待
4. 建议先在测试环境验证功能
5. 如有认证需求，请提供正确的用户名和密码

## 🔍 故障排除

| 问题 | 解决方案 |
|------|----------|
| 连接失败 | 检查ES服务状态和网络连接 |
| 导入失败 | 查看 `es_import.log` 日志文件 |
| 内存不足 | 减少 `--batch-size` 参数值 |
| 权限问题 | 确保用户有索引创建和写入权限 |

## 📈 性能优化

- 使用批量导入API提高效率
- 索引配置优化（单分片、无副本）
- 连接池和重试机制
- 内存友好的数据处理方式

## 🎯 下一步

导入完成后，您可以：
1. 使用 Kibana 可视化数据
2. 通过 REST API 查询数据
3. 集成到现有的监控系统
4. 创建自定义的数据分析脚本

---

如有问题或建议，请查看详细文档 `ES导入脚本使用说明.md` 或提交Issue。
